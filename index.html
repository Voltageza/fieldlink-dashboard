<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FieldLink Pump Controller</title>
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root {
      --bg-primary: #0a0e14;
      --bg-secondary: #111821;
      --bg-card: #151c28;
      --border-color: #1e2a3a;
      --text-primary: #e4e8ef;
      --text-secondary: #6b7a8f;
      --text-muted: #3d4a5c;
      --accent-cyan: #00d4ff;
      --status-running: #00ff88;
      --status-stopped: #6b7a8f;
      --status-fault: #ff4757;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image:
        linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);
    }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon {
      width: 42px; height: 42px;
      background: linear-gradient(135deg, var(--accent-cyan) 0%, #0088aa 100%);
      border-radius: 10px; display: flex; align-items: center; justify-content: center;
      font-family: 'Chakra Petch', sans-serif; font-weight: 700; font-size: 18px;
      color: var(--bg-primary); box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
    }
    .logo-text { font-family: 'Chakra Petch', sans-serif; font-size: 24px; font-weight: 700; }
    .logo-text span { color: var(--accent-cyan); }
    .device-id {
      font-size: 11px; color: var(--text-secondary); margin-top: 2px;
      font-family: 'JetBrains Mono', monospace;
    }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .connection-status {
      display: flex; align-items: center; gap: 8px; padding: 8px 14px;
      background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 6px; font-size: 12px;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--status-fault); }
    .status-dot.connected { background: var(--status-running); box-shadow: 0 0 10px var(--status-running); }
    .btn-settings {
      background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 6px; padding: 8px 12px; cursor: pointer; color: var(--text-secondary);
      font-size: 14px; transition: all 0.2s;
    }
    .btn-settings:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }
    .grid { display: grid; grid-template-columns: 1fr 280px; gap: 20px; }
    .card {
      background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 12px; padding: 20px; margin-bottom: 20px;
    }
    .card-title {
      font-family: 'Chakra Petch', sans-serif; font-size: 12px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary);
      margin-bottom: 16px;
    }
    .state-display { text-align: center; padding: 30px 16px; }
    .state-indicator {
      display: inline-flex; align-items: center; gap: 14px; padding: 16px 40px;
      border-radius: 12px; background: var(--bg-secondary); border: 2px solid var(--border-color);
    }
    .state-indicator.running { border-color: var(--status-running); box-shadow: 0 0 30px rgba(0, 255, 136, 0.2); }
    .state-indicator.fault { border-color: var(--status-fault); box-shadow: 0 0 30px rgba(255, 71, 87, 0.3); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .state-icon { width: 20px; height: 20px; border-radius: 50%; }
    .state-icon.running { background: var(--status-running); box-shadow: 0 0 15px var(--status-running); }
    .state-icon.stopped { background: var(--status-stopped); }
    .state-icon.fault { background: var(--status-fault); box-shadow: 0 0 15px var(--status-fault); }
    .state-text { font-family: 'Chakra Petch', sans-serif; font-size: 28px; font-weight: 700; letter-spacing: 3px; }
    .state-text.running { color: var(--status-running); }
    .state-text.stopped { color: var(--status-stopped); }
    .state-text.fault { color: var(--status-fault); }
    .current-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .current-card {
      background: var(--bg-secondary); border: 1px solid var(--border-color);
      border-radius: 10px; padding: 20px; text-align: center;
    }
    .current-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
    .current-value { font-size: 36px; font-weight: 600; color: var(--accent-cyan); line-height: 1; margin-bottom: 4px; }
    .current-unit { font-size: 12px; color: var(--text-muted); }
    .controls { display: flex; flex-direction: column; gap: 10px; }
    .btn {
      font-family: 'Chakra Petch', sans-serif; font-size: 14px; font-weight: 600;
      letter-spacing: 1.5px; padding: 14px 20px; border: none; border-radius: 10px;
      cursor: pointer; text-transform: uppercase; transition: all 0.2s;
    }
    .btn:hover { transform: translateY(-2px); }
    .btn-start { background: linear-gradient(135deg, #00aa66, #00ff88); color: var(--bg-primary); }
    .btn-stop { background: linear-gradient(135deg, #cc3344, #ff4757); color: white; }
    .btn-reset { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .status-list { display: flex; flex-direction: column; gap: 12px; }
    .status-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px; background: var(--bg-secondary); border-radius: 8px;
    }
    .status-label { font-size: 12px; color: var(--text-secondary); }
    .status-badge {
      padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;
      text-transform: uppercase;
    }
    .status-badge.online { background: rgba(0, 255, 136, 0.15); color: var(--status-running); }
    .status-badge.offline { background: rgba(255, 71, 87, 0.15); color: var(--status-fault); }
    .status-badge.active { background: rgba(0, 212, 255, 0.15); color: var(--accent-cyan); }
    .status-badge.inactive { background: rgba(107, 122, 143, 0.15); color: var(--text-secondary); }
    .uptime-display { text-align: center; padding: 16px; }
    .uptime-value { font-size: 28px; font-weight: 500; letter-spacing: 2px; }
    .uptime-label { font-size: 10px; color: var(--text-muted); margin-top: 6px; }
    .fault-banner {
      display: none; background: rgba(255, 71, 87, 0.15); border: 1px solid var(--status-fault);
      border-radius: 10px; padding: 12px; text-align: center; margin-bottom: 20px;
    }
    .fault-banner.visible { display: block; }
    .fault-banner-text { color: var(--status-fault); font-family: 'Chakra Petch', sans-serif; font-weight: 600; font-size: 13px; }

    /* Landing page styles */
    .landing-page {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 80vh; text-align: center; padding: 40px 20px;
    }
    .landing-page .logo-icon { width: 80px; height: 80px; font-size: 32px; margin-bottom: 20px; }
    .landing-page h1 { font-family: 'Chakra Petch', sans-serif; font-size: 48px; margin-bottom: 10px; }
    .landing-page h1 span { color: var(--accent-cyan); }
    .landing-page .tagline { color: var(--text-secondary); font-size: 16px; margin-bottom: 40px; }
    .device-input-container {
      background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 12px; padding: 30px; max-width: 450px; width: 100%;
    }
    .device-input-container h2 {
      font-family: 'Chakra Petch', sans-serif; font-size: 16px; margin-bottom: 20px;
      color: var(--text-primary);
    }
    .form-group { margin-bottom: 16px; text-align: left; }
    .form-group label {
      display: block; font-size: 11px; color: var(--text-secondary);
      text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;
    }
    .form-input {
      width: 100%; padding: 12px 14px; font-size: 14px;
      background: var(--bg-secondary); border: 1px solid var(--border-color);
      border-radius: 6px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace;
    }
    .form-input:focus { outline: none; border-color: var(--accent-cyan); }
    .form-input::placeholder { color: var(--text-muted); }
    .form-input.device-input {
      font-size: 18px; text-align: center; letter-spacing: 2px; text-transform: uppercase;
      border-width: 2px;
    }
    .form-row { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; }
    .broker-toggle {
      display: flex; gap: 8px; margin-bottom: 20px;
    }
    .broker-toggle button {
      flex: 1; padding: 10px; border: 1px solid var(--border-color);
      background: var(--bg-secondary); color: var(--text-secondary);
      border-radius: 6px; cursor: pointer; font-family: 'Chakra Petch', sans-serif;
      font-size: 12px; text-transform: uppercase; transition: all 0.2s;
    }
    .broker-toggle button.active {
      border-color: var(--accent-cyan); color: var(--accent-cyan);
      background: rgba(0, 212, 255, 0.1);
    }
    .broker-toggle button:hover { border-color: var(--accent-cyan); }
    .custom-broker { display: none; }
    .custom-broker.visible { display: block; }
    .btn-connect {
      width: 100%; margin-top: 20px; background: linear-gradient(135deg, var(--accent-cyan), #0088aa);
      color: var(--bg-primary);
    }
    .device-input-hint {
      font-size: 11px; color: var(--text-muted); margin-top: 12px; text-align: center;
    }
    .last-seen { font-size: 11px; color: var(--text-muted); margin-top: 8px; text-align: center; }
    .last-seen.stale { color: var(--status-fault); }
    .broker-info {
      font-size: 10px; color: var(--text-muted); margin-top: 8px;
      padding: 8px; background: var(--bg-secondary); border-radius: 4px;
    }

    /* Modal styles */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;
    }
    .modal-overlay.visible { display: flex; }
    .modal {
      background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 12px; padding: 30px; max-width: 450px; width: 90%;
    }
    .modal h2 {
      font-family: 'Chakra Petch', sans-serif; font-size: 18px; margin-bottom: 20px;
      color: var(--text-primary);
    }
    .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
    .modal-buttons button { flex: 1; }
    .btn-secondary {
      background: var(--bg-secondary); color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    @media (max-width: 600px) {
      .current-grid { grid-template-columns: 1fr; }
      .landing-page h1 { font-size: 32px; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Landing Page -->
  <div class="container landing-page" id="landingPage">
    <div class="logo-icon">FL</div>
    <h1>Field<span>Link</span></h1>
    <p class="tagline">Industrial Pump Monitoring and Control</p>
    <div class="device-input-container">
      <h2>Connect to Your Device</h2>

      <div class="form-group">
        <label>Device ID</label>
        <input type="text" class="form-input device-input" id="deviceIdInput" placeholder="e.g., FL-A1B2C3" maxlength="12">
      </div>

      <div class="broker-toggle">
        <button id="btnDefaultBroker" class="active" onclick="setBrokerMode('default')">Default Cloud</button>
        <button id="btnCustomBroker" onclick="setBrokerMode('custom')">Custom Broker</button>
      </div>

      <div class="custom-broker" id="customBrokerFields">
        <div class="form-row">
          <div class="form-group">
            <label>Broker Host</label>
            <input type="text" class="form-input" id="brokerHost" placeholder="broker.example.com">
          </div>
          <div class="form-group">
            <label>Port</label>
            <input type="number" class="form-input" id="brokerPort" placeholder="8884" value="8884">
          </div>
        </div>
        <div class="form-group">
          <label>Username</label>
          <input type="text" class="form-input" id="brokerUser" placeholder="username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" class="form-input" id="brokerPass" placeholder="password">
        </div>
        <div class="form-group">
          <label>Protocol</label>
          <select class="form-input" id="brokerProtocol">
            <option value="wss">WSS (Secure WebSocket - Port 8884)</option>
            <option value="ws">WS (WebSocket - Port 8083)</option>
          </select>
        </div>
      </div>

      <div class="broker-info" id="brokerInfo">Using HiveMQ Cloud (Default)</div>

      <button class="btn btn-connect" onclick="connectToDevice()">Connect</button>
      <p class="device-input-hint">Find your Device ID on the serial output or device label</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="container" id="dashboard" style="display: none;">
    <header class="header">
      <div class="logo">
        <div class="logo-icon">FL</div>
        <div>
          <div class="logo-text">Field<span>Link</span></div>
          <div class="device-id" id="displayDeviceId">Device: ---</div>
        </div>
      </div>
      <div class="header-right">
        <button class="btn-settings" onclick="showSettings()" title="Settings">&#9881;</button>
        <div class="connection-status">
          <div class="status-dot" id="mqttStatus"></div>
          <span id="mqttStatusText">Connecting...</span>
        </div>
      </div>
    </header>
    <div class="fault-banner" id="faultBanner">
      <div class="fault-banner-text" id="faultText">FAULT DETECTED</div>
    </div>
    <div class="grid">
      <div class="main">
        <div class="card">
          <div class="card-title">Pump Status</div>
          <div class="state-display">
            <div class="state-indicator stopped" id="stateIndicator">
              <div class="state-icon stopped" id="stateIcon"></div>
              <div class="state-text stopped" id="stateText">---</div>
            </div>
          </div>
          <div class="last-seen" id="lastSeen">Waiting for data...</div>
        </div>
        <div class="card">
          <div class="card-title">Phase Currents</div>
          <div class="current-grid">
            <div class="current-card">
              <div class="current-label">Phase A</div>
              <div class="current-value" id="currentA">--</div>
              <div class="current-unit">Amps</div>
            </div>
            <div class="current-card">
              <div class="current-label">Phase B</div>
              <div class="current-value" id="currentB">--</div>
              <div class="current-unit">Amps</div>
            </div>
            <div class="current-card">
              <div class="current-label">Phase C</div>
              <div class="current-value" id="currentC">--</div>
              <div class="current-unit">Amps</div>
            </div>
          </div>
        </div>
      </div>
      <div class="side">
        <div class="card">
          <div class="card-title">Controls</div>
          <div class="controls">
            <button class="btn btn-start" id="btnStart" onclick="sendCommand('START')">Start Pump</button>
            <button class="btn btn-stop" id="btnStop" onclick="sendCommand('STOP')">Stop Pump</button>
            <button class="btn btn-reset" id="btnReset" onclick="sendCommand('RESET')">Reset Fault</button>
          </div>
        </div>
        <div class="card">
          <div class="card-title">System Info</div>
          <div class="status-list">
            <div class="status-item">
              <span class="status-label">Sensor</span>
              <span class="status-badge offline" id="sensorStatus">OFFLINE</span>
            </div>
            <div class="status-item">
              <span class="status-label">Command</span>
              <span class="status-badge inactive" id="cmdStatus">INACTIVE</span>
            </div>
            <div class="status-item">
              <span class="status-label">Mode</span>
              <span class="status-badge inactive" id="modeStatus">---</span>
            </div>
          </div>
          <div class="uptime-display">
            <div class="uptime-value" id="uptime">--:--:--</div>
            <div class="uptime-label">DEVICE UPTIME</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <h2>Connection Settings</h2>
      <div class="form-group">
        <label>Device ID</label>
        <input type="text" class="form-input" id="modalDeviceId" readonly>
      </div>
      <div class="form-group">
        <label>Broker</label>
        <input type="text" class="form-input" id="modalBroker" readonly>
      </div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="hideSettings()">Close</button>
        <button class="btn btn-stop" onclick="disconnect()">Disconnect</button>
      </div>
    </div>
  </div>

  <script>
    // Default HiveMQ Cloud Configuration
    const DEFAULT_BROKER = 'wss://a5c598acdbdc4abba053799bcefb73d0.s1.eu.hivemq.cloud:8884/mqtt';
    const DEFAULT_USER = 'fieldlogicuser1';
    const DEFAULT_PASS = '@Shadow69';

    let client = null;
    let isConnected = false;
    let deviceId = null;
    let lastDataTime = null;
    let staleCheckInterval = null;
    let brokerMode = 'default';
    let mqttConfig = {
      broker: DEFAULT_BROKER,
      user: DEFAULT_USER,
      pass: DEFAULT_PASS
    };

    // Load saved settings from localStorage
    function loadSettings() {
      try {
        const saved = localStorage.getItem('fieldlink_settings');
        if (saved) {
          const settings = JSON.parse(saved);
          if (settings.brokerMode) brokerMode = settings.brokerMode;
          if (settings.mqttConfig) mqttConfig = settings.mqttConfig;
          if (settings.deviceId) {
            document.getElementById('deviceIdInput').value = settings.deviceId;
          }
          if (brokerMode === 'custom') {
            setBrokerMode('custom');
            document.getElementById('brokerHost').value = settings.customHost || '';
            document.getElementById('brokerPort').value = settings.customPort || '8884';
            document.getElementById('brokerUser').value = settings.customUser || '';
            document.getElementById('brokerPass').value = settings.customPass || '';
            document.getElementById('brokerProtocol').value = settings.customProtocol || 'wss';
          }
        }
      } catch (e) {
        console.error('Error loading settings:', e);
      }
    }

    // Save settings to localStorage
    function saveSettings() {
      try {
        const settings = {
          deviceId: deviceId,
          brokerMode: brokerMode,
          mqttConfig: mqttConfig
        };
        if (brokerMode === 'custom') {
          settings.customHost = document.getElementById('brokerHost').value;
          settings.customPort = document.getElementById('brokerPort').value;
          settings.customUser = document.getElementById('brokerUser').value;
          settings.customPass = document.getElementById('brokerPass').value;
          settings.customProtocol = document.getElementById('brokerProtocol').value;
        }
        localStorage.setItem('fieldlink_settings', JSON.stringify(settings));
      } catch (e) {
        console.error('Error saving settings:', e);
      }
    }

    // Toggle broker mode
    function setBrokerMode(mode) {
      brokerMode = mode;
      document.getElementById('btnDefaultBroker').classList.toggle('active', mode === 'default');
      document.getElementById('btnCustomBroker').classList.toggle('active', mode === 'custom');
      document.getElementById('customBrokerFields').classList.toggle('visible', mode === 'custom');

      if (mode === 'default') {
        document.getElementById('brokerInfo').textContent = 'Using HiveMQ Cloud (Default)';
      } else {
        document.getElementById('brokerInfo').textContent = 'Using custom MQTT broker';
      }
    }

    // Get device ID from URL parameter
    function getDeviceIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('device') || params.get('id') || params.get('d');
    }

    // Update URL with device ID
    function updateUrl(id) {
      const url = new URL(window.location);
      url.searchParams.set('device', id);
      window.history.pushState({}, '', url);
    }

    // Build MQTT broker URL from custom fields
    function buildCustomBrokerUrl() {
      const protocol = document.getElementById('brokerProtocol').value;
      const host = document.getElementById('brokerHost').value.trim();
      const port = document.getElementById('brokerPort').value.trim() || '8884';
      return protocol + '://' + host + ':' + port + '/mqtt';
    }

    // Connect to device from landing page
    function connectToDevice() {
      const input = document.getElementById('deviceIdInput');
      const id = input.value.trim().toUpperCase();

      if (id.length < 4) {
        input.style.borderColor = 'var(--status-fault)';
        setTimeout(function() { input.style.borderColor = 'var(--border-color)'; }, 2000);
        return;
      }

      // Build MQTT config based on mode
      if (brokerMode === 'custom') {
        const host = document.getElementById('brokerHost').value.trim();
        if (!host) {
          alert('Please enter a broker host');
          return;
        }
        mqttConfig = {
          broker: buildCustomBrokerUrl(),
          user: document.getElementById('brokerUser').value.trim(),
          pass: document.getElementById('brokerPass').value
        };
      } else {
        mqttConfig = {
          broker: DEFAULT_BROKER,
          user: DEFAULT_USER,
          pass: DEFAULT_PASS
        };
      }

      updateUrl(id);
      initDashboard(id);
    }

    // Handle Enter key on input
    document.addEventListener('DOMContentLoaded', function() {
      loadSettings();

      var input = document.getElementById('deviceIdInput');
      if (input) {
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') connectToDevice();
        });
      }

      // Check for device ID in URL
      var urlDeviceId = getDeviceIdFromUrl();
      if (urlDeviceId) {
        document.getElementById('deviceIdInput').value = urlDeviceId;
        // Auto-connect if we have saved settings
        var saved = localStorage.getItem('fieldlink_settings');
        if (saved) {
          connectToDevice();
        }
      }
    });

    // Initialize dashboard with device ID
    function initDashboard(id) {
      deviceId = id.toUpperCase();
      document.getElementById('landingPage').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('displayDeviceId').textContent = 'Device: ' + deviceId;
      document.title = 'FieldLink - ' + deviceId;

      // Save settings
      saveSettings();

      // Start stale data checker
      staleCheckInterval = setInterval(checkStaleData, 5000);

      connect();
    }

    // Check if data is stale
    function checkStaleData() {
      var lastSeenEl = document.getElementById('lastSeen');
      if (!lastDataTime) {
        lastSeenEl.textContent = 'Waiting for data...';
        lastSeenEl.classList.remove('stale');
        return;
      }

      var secondsAgo = Math.floor((Date.now() - lastDataTime) / 1000);
      if (secondsAgo > 10) {
        lastSeenEl.textContent = 'Last data: ' + secondsAgo + 's ago - Device may be offline';
        lastSeenEl.classList.add('stale');
      } else {
        lastSeenEl.textContent = 'Live data';
        lastSeenEl.classList.remove('stale');
      }
    }

    function formatUptime(s) {
      var h = Math.floor(s / 3600);
      var m = Math.floor((s % 3600) / 60);
      var sec = s % 60;
      return h.toString().padStart(2,'0') + ':' + m.toString().padStart(2,'0') + ':' + sec.toString().padStart(2,'0');
    }

    function updateState(state) {
      var s = state.toLowerCase();
      document.getElementById('stateIndicator').className = 'state-indicator ' + s;
      document.getElementById('stateIcon').className = 'state-icon ' + s;
      document.getElementById('stateText').className = 'state-text ' + s;
      document.getElementById('stateText').textContent = state;
      document.getElementById('faultBanner').classList.toggle('visible', s === 'fault');
      document.getElementById('btnStart').disabled = s === 'fault';
      document.getElementById('btnReset').disabled = s !== 'fault';
    }

    function updateTelemetry(data) {
      try {
        var t = JSON.parse(data);
        lastDataTime = Date.now();

        document.getElementById('currentA').textContent = parseFloat(t.Ia).toFixed(1);
        document.getElementById('currentB').textContent = parseFloat(t.Ib).toFixed(1);
        document.getElementById('currentC').textContent = parseFloat(t.Ic).toFixed(1);
        updateState(t.state);
        if (t.fault) document.getElementById('faultText').textContent = 'FAULT: ' + t.fault;

        document.getElementById('sensorStatus').textContent = t.sensor ? 'ONLINE' : 'OFFLINE';
        document.getElementById('sensorStatus').className = 'status-badge ' + (t.sensor ? 'online' : 'offline');
        document.getElementById('cmdStatus').textContent = t.cmd ? 'ACTIVE' : 'INACTIVE';
        document.getElementById('cmdStatus').className = 'status-badge ' + (t.cmd ? 'active' : 'inactive');

        // Mode indicator
        if (t.mode) {
          document.getElementById('modeStatus').textContent = t.mode;
          document.getElementById('modeStatus').className = 'status-badge ' + (t.mode === 'REMOTE' ? 'active' : 'inactive');
        }

        document.getElementById('uptime').textContent = formatUptime(t.uptime);
        document.getElementById('lastSeen').textContent = 'Live data';
        document.getElementById('lastSeen').classList.remove('stale');
      } catch (e) {
        console.error('Parse error:', e);
      }
    }

    function sendCommand(cmd) {
      if (client && isConnected && deviceId) {
        var topic = 'fieldlink/' + deviceId + '/command';
        client.publish(topic, cmd);
        console.log('Sent to ' + topic + ':', cmd);
      } else {
        alert('Not connected to device');
      }
    }

    function connect() {
      if (!deviceId) return;

      document.getElementById('mqttStatusText').textContent = 'Connecting...';
      console.log('Connecting to:', mqttConfig.broker);

      client = mqtt.connect(mqttConfig.broker, {
        username: mqttConfig.user,
        password: mqttConfig.pass,
        clientId: 'dashboard_' + deviceId + '_' + Math.random().toString(16).substr(2, 8),
        reconnectPeriod: 5000
      });

      client.on('connect', function() {
        isConnected = true;
        document.getElementById('mqttStatus').classList.add('connected');
        document.getElementById('mqttStatusText').textContent = 'Connected';

        var topic = 'fieldlink/' + deviceId + '/telemetry';
        client.subscribe(topic, function(err) {
          if (!err) {
            console.log('Subscribed to:', topic);
          }
        });
      });

      client.on('message', function(topic, msg) {
        if (topic === 'fieldlink/' + deviceId + '/telemetry') {
          updateTelemetry(msg.toString());
        }
      });

      client.on('close', function() {
        isConnected = false;
        document.getElementById('mqttStatus').classList.remove('connected');
        document.getElementById('mqttStatusText').textContent = 'Disconnected';
      });

      client.on('reconnect', function() {
        document.getElementById('mqttStatusText').textContent = 'Reconnecting...';
      });

      client.on('error', function(err) {
        console.error('MQTT Error:', err);
        document.getElementById('mqttStatusText').textContent = 'Error';
      });
    }

    function showSettings() {
      document.getElementById('modalDeviceId').value = deviceId;
      document.getElementById('modalBroker').value = mqttConfig.broker;
      document.getElementById('settingsModal').classList.add('visible');
    }

    function hideSettings() {
      document.getElementById('settingsModal').classList.remove('visible');
    }

    function disconnect() {
      if (client) {
        client.end();
        client = null;
      }
      isConnected = false;
      if (staleCheckInterval) {
        clearInterval(staleCheckInterval);
      }
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('landingPage').style.display = 'flex';
      hideSettings();
    }
  </script>
</body>
</html>
